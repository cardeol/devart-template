<!doctype html>
<html>
<head>
<script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script>
<script type="text/javascript" src="scripts/videoAscii.js"></script>
</head>
<body>
<video width="400" height="300" autoplay></video>
<img src="">
<canvas style="display:none;"></canvas>
<script>
  var video = document.querySelector('video');
  var canvas = document.querySelector('canvas');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;
  var vgaConstraints = {
    video: {
      mandatory: {
        minWidth: 1280,
        minHeight: 720
      }
    },
    audio: false
  };

  navigator.getUserMedia  = navigator.getUserMedia ||
                            navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia ||
                            navigator.msGetUserMedia;

  if (navigator.getUserMedia) {
    navigator.getUserMedia(vgaConstraints, function(stream) {
      video.src = window.URL.createObjectURL(stream);
    }, errorCallback);
  } else {
    video.src = 'somevideo.webm'; // fallback.
  }

  var errorCallback = function(e) {
    console.log('Reeeejected!', e);
  };

  navigator.getUserMedia(vgaConstraints, function(localMediaStream) {
    var video = document.querySelector('video');
    video.src = window.URL.createObjectURL(localMediaStream);

    // Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
    // See crbug.com/110938.
    video.onloadedmetadata = function(e) {
      // Ready to go. Do some stuff.
    };
  }, errorCallback);

  function snapshot() {
    if (localMediaStream) {
      ctx.drawImage(video, 0, 0);
      // "image/webp" works in Chrome.
      // Other browsers will fall back to image/png.
      //document.querySelector('img').src = 
      videoAscii.onComplete = function(response) {
          $("#result").html(response);
          if (true) setTimeout(function() {
              console.log("...");
              ctx.drawImage(video, 0, 0);
              var y = new Image();
              y.src = canvas.toDataURL('image/png');
              $("#rimg").attr("src",canvas.toDataURL());
              y.onload = function() {
                videoAscii.create(y);
              }
              
          }, 500);
      };
      videoAscii.init(canvas.toDataURL());
      ;
    }
  }

  video.addEventListener('click', snapshot, false);

  // Not showing vendor prefixes or code that works cross-browser.
  navigator.getUserMedia({video: true}, function(stream) {
    video.src = window.URL.createObjectURL(stream);
    localMediaStream = stream;
  }, errorCallback);
</script>
<div id="result"></div>
<button onclick="javascript:snapshot();">snap</button>
<img id="rimg" />
</body>
</html>